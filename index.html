<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ONZEN TEST</title>
<link href="https://fonts.googleapis.com/css?family=Sriracha" rel="stylesheet" type='text/css'>


    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery/2.0.0/jquery.min.js"></script>
    <script src="dist/jquery.cropit.js"></script>
    <script src="dist/jquery-ui.js"></script>
    <script src="dist/jquery.ui.touch-punch.min.js"></script>
    <link rel="stylesheet" href="dist/css/app.css">

</head>
<body>

<ons-navigator id="myNavigator" page="page1.html"></ons-navigator>

<ons-template id="page1.html">
    <ons-page id="page1">

        <ons-toolbar >

            <div class="center" style="text-align: center">Step 1</div>
            <div class="right">

                <ons-toolbar-button id="next-page2"  disabled >
                    Next &nbsp<i class="zmdi zmdi zmdi-play zmdi-hc-lg"></i>
                </ons-toolbar-button>
            </div>

        </ons-toolbar>

        <div class="image-editor">
            <ons-row >

                <label class="fileContainer">
                    <input type="file" class="cropit-image-input"/>
                </label>

            </ons-row>
            <ons-row>
                <!--<ons-col width="10px">   </ons-col>-->

                <div class="cropit-preview"></div>

            </ons-row>


            <table >
                <tr>
                    <td><ons-icon size="15px" icon="md-flower-alt" ></ons-icon></td>
                    <td><input type="range" class="cropit-image-zoom-input custom"></td>
                    <td><ons-icon size="30px" icon="md-flower-alt" ></ons-icon></td>
                    <td>&nbsp;</td>
                    <td><ons-button class="rotate-ccw" ><ons-icon icon="md-rotate-left"></ons-icon></ons-button></td>
                    <td><ons-button class="rotate-cw" ><ons-icon icon="md-rotate-right"></ons-icon></ons-button></td>
                </tr>
            </table>
        </div>

    </ons-page>
</ons-template>

<ons-template id="page2.html">
    <ons-page id="page2">
        <ons-toolbar>
            <div class="left"><ons-back-button>Back</ons-back-button></div>
            <div class="center" style="text-align: center">Step 2</div>
            <div class="right">
            <ons-toolbar-button id="next-page3" >
                Next &nbsp<i class="zmdi zmdi zmdi-play zmdi-hc-lg"></i>
            </ons-toolbar-button>
            </div>
        </ons-toolbar>
        <ons-row>
        <ons-col>
        <canvas id="canvasText" width="140" height="100" ></canvas>
        </ons-col>
            <ons-col width="24%">
                <ons-list modifier="material">
                    <ons-list-header>ขนาด</ons-list-header>
                    <ons-list-item tappable>
                        <ons-select id="choose-size" onchange="sizeSelects(event)">
                            <option value="30px">เล็ก </option>
                            <option value="40px" selected>กลาง</option>
                            <option value="50px">ใหญ่</option>
                        </ons-select>
                    </ons-list-item>
                </ons-list>
            </ons-col>
            <ons-col width="20%">
                <ons-list modifier="material">
                    <ons-list-header>สี</ons-list-header>
                    <ons-list-item tappable>
                <ons-select id="choose-color" onchange="colorSelects(event)">
                    <option value="red" ><div style="color: red">แดง</div></option>
                    <option value="green"><div style="color: green">เขียว</div></option>
                    <option value="blue"><div style="color: blue">น้ำเงิน</div></option>
                </ons-select>
                    </ons-list-item>
                </ons-list>
            </ons-col>
            <ons-col width="16%">
                <ons-list modifier="material">
                    <ons-list-header>ขอบ</ons-list-header>
                    <ons-list-item tappable>
                        <ons-select id="choose-stroke" onchange="strokeSelects(event)">
                            <option value="black">ดำ</option>
                            <option value="white">ขาว</option>
                            <option value="none">ไม่มี</option>
                        </ons-select>
                    </ons-list-item>
                </ons-list>
       <!-- <ons-list modifier="material">
            <ons-list-header>ขอบ</ons-list-header>
            <ons-list-item tappable>
                <label class="left">
                    <ons-radio name="color" input-id="radio-1" checked></ons-radio>
                </label>
                <label for="radio-1" class="center">
                    ดำ
                </label>
            </ons-list-item>
            <ons-list-item id="radioBlue" tappable>
                <label class="left">
                    <ons-radio name="color" input-id="radio-2"></ons-radio>
                </label>
                <label for="radio-2" class="center">
                    ขาว
                </label>
            </ons-list-item>
        </ons-list>-->
            </ons-col>
        </ons-row>
    </ons-page>
</ons-template>
<ons-template id="page3.html">
    <ons-page id="page3">

        <ons-toolbar>
            <div class="left"><ons-back-button>Back</ons-back-button></div>
            <div class="center" style="text-align: center">Step 3</div>
            <div class="right">
            <ons-toolbar-button id="next-page4" >
                Next &nbsp<i class="zmdi zmdi zmdi-play zmdi-hc-lg"></i>
            </ons-toolbar-button>
                </div>
        </ons-toolbar>

        <!--<div id="dropThis">-->
        <canvas id="canvas1" width="370" height="320" ></canvas>
        <!--</div>-->
        <ons-gesture-detector>
            <!--<div id="dragThis">-->
            <canvas id="txtCanvas" class="draggable" width="140" height="100"  style="position:absolute; top:0px; left:0px"></canvas>
            <!--</div>-->
        </ons-gesture-detector>
    </ons-page>
</ons-template>
<ons-template id="page4.html">
    <ons-page id="page4">
        <ons-toolbar>
            <div class="left"><ons-back-button>Back</ons-back-button></div>
            <div class="center"></div>
        </ons-toolbar>
        <canvas id="canvas4" width="370" height="320" ></canvas>
    </ons-page>
</ons-template>
<script>
    //$(document.body).css('overflow-y', 'hidden');
    var posX =0,posY=0;
    var imageData,c,context_can,image;
    var txtColor = 'red',borderColor ='black',txtSize='40px';

    function clearCanvas(canvasName){
        let canvas =document.getElementById(canvasName);
        let ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function drawText(wordIng,canvasName,textColor,strokeColor='black',fontSize='40px',fontName='Sriracha',xPos='0',yPos='0'){
        let canvas =document.getElementById(canvasName);

        if ((canvasName === 'canvasText')&&(strokeColor=== 'white')){
            canvas.style.background ='black';
        } else {canvas.style.background='transparent'}
        let ctx = canvas.getContext("2d");
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.font = fontSize + ' '+ fontName;
        ctx.fillStyle = textColor;
        ctx.strokeStyle = strokeColor;
        if ((strokeColor ==='black')&& (fontSize==='40px'||(fontSize==='50px'))) {
            ctx.lineWidth = 2;
        } else {
            ctx.lineWidth = 1;
        }
        ctx.fillText(wordIng, xPos, yPos);
        ctx.strokeText(wordIng, xPos, yPos);
        ctx.fill();
        ctx.stroke();
    }
    function colorSelects(event) {
        txtColor = event.target.value;
        clearCanvas("canvasText");
        drawText("รักแม่","canvasText",txtColor,borderColor,txtSize,"Sriracha",0,0);
    }
    function sizeSelects(event) {
        txtSize = event.target.value;
        clearCanvas("canvasText");
        drawText("รักแม่","canvasText",txtColor,borderColor,txtSize,"Sriracha",0,0);
    }
    function strokeSelects(event) {
        if (event.target.value==='none'){ borderColor = txtColor } // No border
        else {borderColor = event.target.value;}
        clearCanvas("canvasText");
        drawText("รักแม่","canvasText",txtColor,borderColor,txtSize,"Sriracha",0,0);
    }
    document.addEventListener("show",function(e){
        if(e.target.id == 'page3'){
            fn.enableGD();
        } else if (e.target.id == 'page2'){ // make font show correct


            clearCanvas("canvasText");
            drawText("รักแม่","canvasText",txtColor,borderColor,txtSize,"Sriracha",0,0);

        }
    });
    var margin_top = $(".toolbar").css("height");
    window.fn = {};
//    fn.vtop = parseInt(margin_top);
    fn.vtop = 0;
    fn.vleft = 0;
    window.fn.enableGD = function(){

        var dragItems = document.querySelectorAll('.draggable');
        for (var i = 0; i < dragItems.length; i++) {
            dragItems[i].addEventListener('dragstart', function(e) {
                fn.vtop = parseInt(e.target.style.top || 0,10);
                fn.vleft = parseInt(e.target.style.left || 0,10);

            });
            dragItems[i].addEventListener('drag', function(e) {
                e.target.style.top = parseInt(fn.vtop + e.gesture.deltaY) + 'px';

                e.target.style.left = parseInt(fn.vleft + e.gesture.deltaX) + 'px';

                //document.getElementById('status').value = "Dragging";
                //document.getElementById('xdel').value = e.gesture.deltaX;
                //document.getElementById('ydel').value = e.gesture.deltaY;
                //document.getElementById('xpos').value = e.target.style.left;
                //document.getElementById('ypos').value = e.target.style.top;
            });
            dragItems[i].addEventListener('dragend', function(e) {
                // THIS EVENT IS NOT REQUIRED UNLESS YOU ARE DETECTING DROP
                fn.vtop = parseInt(e.target.style.top || 0,10);
                fn.vleft = parseInt(e.target.style.left || 0,10);


                console.log("x : "+fn.vleft);
                console.log("y : "+fn.vtop);


                posX =  parseInt(fn.vleft);
                posY =  parseInt(fn.vtop);

            });
        }
    }
    document.addEventListener('init', function(event) {
        var page = event.target;

        if (page.id === 'page1') {
            $('.image-editor').cropit({
                smallImage: 'allow',
                initialZoom: 'min', // 'image'
                minZoom: 'fill', // 'fit'
                freeMove :true,
                imageBackground: true,
                onImageError: function(e) {
                    ons.notification.alert(e.message);
                },
                onImageLoaded: function(ev){
                    $('#next-page2').attr('disabled', false);  // make Next button Enable
                }
            });
            // $('.image-editor').cropit('previewSize', { width: 370, height: 320 });
            $('.image-editor').cropit();

            $('.rotate-cw').click(function() {
                $('.image-editor').cropit('rotateCW');
            });
            $('.rotate-ccw').click(function() {
                $('.image-editor').cropit('rotateCCW');
            });
            page.querySelector('#next-page2').onclick = function() {

                document.querySelector('#myNavigator').pushPage('page2.html', {data: {title: 'Step 2'}});
            };

        } else if (page.id === 'page2') {
            page.querySelector('ons-toolbar .center').innerHTML = page.data.title;
            function page2draw() {
                clearCanvas("canvasText");
                console.log("draw");
                drawText("รักแม่","canvasText",txtColor,borderColor,txtSize);

            }

            page.querySelector('#next-page3').onclick = function() {

                document.querySelector('#myNavigator').pushPage('page3.html', {data: {title: 'Page 3'}});
            };
            page2draw();

/*            page.querySelector('#radio-2').onclick = function(){

                borderColor ='white';
                clearCanvas("canvasText");
                drawText("รักแม่","canvasText",txtColor,borderColor,txtSize);
              console.log("in 2 change") ;
            };
            page.querySelector('#radio-1').onclick = function(){

                borderColor ='black';
                clearCanvas("canvasText");
                drawText("รักแม่","canvasText",txtColor,borderColor,txtSize);
                console.log("in 1 change") ;
            }*/
            /* page2draw();
             page2clear();
             page2draw();
             page2clear();
             page2draw();
             page2clear();
             page2draw();*/


        } else if (page.id === 'page3') {
            page.querySelector('ons-toolbar .center').innerHTML = page.data.title;

            /* Initialize Firebase
             var config = {
             apiKey: "AIzaSyA83WDgXFYbIXc6wI0D6tpShrIhMW8teRQ",
             authDomain: "mysticker-f7d1e.firebaseapp.com",
             databaseURL: "https://mysticker-f7d1e.firebaseio.com",
             projectId: "mysticker-f7d1e",
             storageBucket: "mysticker-f7d1e.appspot.com",
             messagingSenderId: "342976982342"
             };
             firebase.initializeApp(config);
             */
            document.body._gestureDetector.dispose(); // Touch Enable
            imageData = $('.image-editor').cropit('export', {
                quality: 1
            });

            c = document.getElementById("canvas1");
            context_can = c.getContext("2d");
            image = new Image();
            image.onload = function() {
                context_can.drawImage(image, 0, 0);
                /*                context_can.font = "35pt Sriracha";
                 context_can.fillStyle = "red"
                 context_can.strokeStyle = 'black';
                 context_can.lineWidth = 3
                 context_can.fillText("รักแม่", 40, 40);
                 context_can.strokeText("รักแม่", 40, 40);
                 context_can .fill();
                 context_can.stroke();*/
            };
            image.src = imageData;
            drawText("รักแม่","txtCanvas",txtColor,borderColor,txtSize,"Sriracha",0,0);


            page.querySelector('#next-page4').onclick = function() {

                document.querySelector('#myNavigator').pushPage('page4.html', {data: {title: 'Page 4'}});

            };

        } else if (page.id === 'page4') {
            page.querySelector('ons-toolbar .center').innerHTML = page.data.title;


            c = document.getElementById("canvas4");
            context_can = c.getContext("2d");
            image = new Image();
            image.onload = function() {
                var margin_top = $(".toolbar").css("height");
                console.log("margin :"+margin_top);
                console.log("x : "+posX);
                console.log("y : "+posY);
                context_can.drawImage(image, 0, 0);
                drawText("รักแม่","canvas4",txtColor,borderColor,txtSize,"Sriracha",posX,posY);

            };
            image.src = imageData;

/*            var w=window.open('about:blank','image from canvas');
            w.document.write("<img src='"+ c.toDataURL("image/png")+"' alt='from canvas'/>")*/
        }
    });

</script>
</body>
</html>